<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Gestion des Ic√¥nes - IHM Industrielle</title>
    <link rel="stylesheet" href="/static/css/graphics/icons_library.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üé® Gestion des Ic√¥nes</h1>
                <p>Organisez votre biblioth√®que d'ic√¥nes et d'images pour l'√©diteur graphique</p>
            </div>
            <div class="header-actions">
                <a href="/graphics/designer" class="btn btn-success">‚úèÔ∏è Retour √âditeur</a>
                <a href="/dashboard" class="btn btn-secondary">üìä Dashboard</a>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-number" id="total-icons">0</div>
                <div class="stat-label">Total Ic√¥nes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè≠</div>
                <div class="stat-number" id="industrial-icons">0</div>
                <div class="stat-label">Industrielles</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üé®</div>
                <div class="stat-number" id="custom-icons">0</div>
                <div class="stat-label">Personnalis√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîó</div>
                <div class="stat-number" id="external-icons">0</div>
                <div class="stat-label">Externes</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar filtres -->
            <div class="sidebar">
                <h3>üîç Filtres & Recherche</h3>
                
                <div class="filter-group">
                    <label>Rechercher</label>
                    <input type="text" id="search-input" placeholder="Nom d'ic√¥ne..." onkeyup="filterIcons()">
                </div>

                <div class="filter-group">
                    <label>Cat√©gorie</label>
                    <select id="category-filter" onchange="filterIcons()">
                        <option value="all">Toutes</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Type</label>
                    <select id="type-filter" onchange="filterIcons()">
                        <option value="all">Tous</option>
                        <option value="industrial">Industrielles</option>
                        <option value="external">Externes</option>
                        <option value="upload">Personnalis√©es</option>
                    </select>
                </div>

                <button class="btn btn-outline" onclick="clearFilters()" style="width: 100%;">
                    üîÑ Effacer Filtres
                </button>

                <hr style="margin: 25px 0; border: 1px solid var(--border-color);">

                <h3>üì§ Upload Zone</h3>
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">
                        <h3>Ajoutez vos images</h3>
                        <p>Glissez-d√©posez ou cliquez</p>
                        <p class="upload-info">PNG, JPG, SVG, GIF (max 5MB)</p>
                    </div>
                </div>
                <input type="file" id="file-input" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
            </div>

            <!-- Zone principale -->
            <div class="icons-section">
                <div class="section-header">
                    <h3 id="section-title">üìö Biblioth√®que d'Ic√¥nes</h3>
                    <div>
                        <span id="icons-count">0 ic√¥ne(s)</span>
                    </div>
                </div>

                <div id="icons-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Chargement des ic√¥nes...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de pr√©visualisation -->
    <div class="modal-overlay" id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã D√©tails de l'Ic√¥ne</h3>
                <button class="modal-close" onclick="closeModal('preview-modal')">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let allIcons = [];
        let filteredIcons = [];
        let selectedIcons = new Set();

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé® Interface de gestion des ic√¥nes initialis√©e');
            loadIcons();
            setupDragAndDrop();
        });

        // Chargement des ic√¥nes
        async function loadIcons() {
            try {
                const response = await fetch('/api/graphics/icons');
                const result = await response.json();

                if (result.success) {
                    allIcons = result.icons;
                    filteredIcons = [...allIcons];
                    
                    renderIcons();
                    updateStatistics();
                    populateCategories();
                    
                    console.log(`‚úÖ ${allIcons.length} ic√¥nes charg√©es`);
                } else {
                    showNotification('Erreur de chargement: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur chargement ic√¥nes:', error);
                showNotification('Impossible de charger les ic√¥nes', 'error');
            }
        }

        // Rendu des ic√¥nes
        function renderIcons() {
            const container = document.getElementById('icons-container');
            
            if (filteredIcons.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>Aucune ic√¥ne trouv√©e</h3>
                        <p>Essayez de modifier vos filtres ou d'ajouter de nouvelles ic√¥nes</p>
                    </div>
                `;
                document.getElementById('icons-count').textContent = '0 ic√¥ne(s)';
                return;
            }

            // Grouper par cat√©gorie
            const iconsByCategory = {};
            filteredIcons.forEach(icon => {
                const category = icon.categorie || 'Sans cat√©gorie';
                if (!iconsByCategory[category]) {
                    iconsByCategory[category] = [];
                }
                iconsByCategory[category].push(icon);
            });

            let html = '';
            
            Object.keys(iconsByCategory).sort().forEach(category => {
                const icons = iconsByCategory[category];
                
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">
                            ${getCategoryDisplayName(category)} (${icons.length})
                        </h4>
                        <div class="icons-grid">
                `;

                icons.forEach(icon => {
                    html += createIconCardHTML(icon);
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('icons-count').textContent = `${filteredIcons.length} ic√¥ne(s)`;
        }

        function createIconCardHTML(icon) {
            const iconId = icon.id_icon || icon.id;
            let previewHTML = '';
            let typeClass = '';

            // Ic√¥nes industrielles / Unicode
            if (icon.type_source === 'industrial' || icon.is_unicode) {
                previewHTML = `<span style="font-size: 3em;">${icon.unicode_char || 'üîß'}</span>`;
                typeClass = 'industrial-icon';
            } 
            // Ic√¥nes externes
            else if (icon.type_source === 'external') {
                typeClass = 'external-icon';
                previewHTML = `<div style="font-size: 3em; color: var(--primary-color);">üîó</div>`;
            } 
            // Ic√¥nes upload√©es
            else if (icon.type_source === 'upload' && icon.fichier_path) {
                typeClass = 'custom-icon';
                previewHTML = `<img src="${icon.url}" alt="${icon.nom_icon}" style="max-width: 200px; max-height: 200px;">`;
            }  
            // Ic√¥nes par d√©faut
            else {
                previewHTML = `<div style="font-size: 3em; color: var(--text-muted);">üì∑</div>`;
            }

            const isSelected = selectedIcons.has(iconId);

            return `
                <div class="icon-card ${typeClass} ${isSelected ? 'selected' : ''}" data-icon-id="${iconId}">
                    <div class="icon-actions">
                        <button class="action-btn select" onclick="toggleSelection(${iconId})" title="S√©lectionner">
                            ${isSelected ? '‚úì' : '+'}
                        </button>
                        <button class="action-btn edit" onclick="editIcon(${iconId})" title="Modifier">
                            ‚úèÔ∏è
                        </button>
                        <button class="action-btn delete" onclick="deleteIcon(${iconId})" title="Supprimer">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div class="icon-preview" onclick="previewIcon(${iconId})">
                        ${previewHTML}
                    </div>

                    <div class="icon-info">
                        <h4>${icon.nom_icon}</h4>
                        <div class="icon-meta">${icon.categorie || 'Sans cat√©gorie'}</div>
                        <div class="icon-meta">${icon.largeur_defaut || 32}√ó${icon.hauteur_defaut || 32}px</div>
                        <div class="icon-meta">${getTypeDisplayName(icon.type_source)}</div>
                    </div>
                </div>
            `;
        }



        // Gestion de la s√©lection
        function toggleSelection(iconId) {
            if (selectedIcons.has(iconId)) {
                selectedIcons.delete(iconId);
            } else {
                selectedIcons.add(iconId);
            }
            renderIcons();
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const count = selectedIcons.size;
            if (count > 0) {
                document.getElementById('section-title').innerHTML = `üìö Biblioth√®que d'Ic√¥nes (${count} s√©lectionn√©e(s))`;
            } else {
                document.getElementById('section-title').innerHTML = `üìö Biblioth√®que d'Ic√¥nes`;
            }
        }

        function previewIcon(iconId) {
            const icon = allIcons.find(i => (i.id_icon || i.id) === iconId);
            if (!icon) return;

            let previewHTML = '';

            // Ic√¥nes industrielles / Unicode
            if (icon.type_source === 'industrial' || icon.is_unicode) {
                previewHTML = `<div style="font-size: 5em; text-align: center; margin: 20px 0;">
                    ${icon.unicode_char || 'üîß'}
                </div>`;
            } 
            // Ic√¥nes upload√©es
            else if (icon.type_source === 'upload' && icon.fichier_path) {
                previewHTML = `<div style="text-align:center; margin:20px 0;">
                                <img src="${icon.url}" alt="${icon.nom_icon}" style="max-width: 300px; max-height: 300px;">
                            </div>`;
}
            // Ic√¥nes externes
            else if (icon.type_source === 'external') {
                previewHTML = `<div style="font-size: 5em; text-align: center; margin: 20px 0; color: var(--primary-color);">
                    üîó
                </div>`;
            } 
            // Ic√¥nes par d√©faut
            else {
                previewHTML = `<div style="font-size: 5em; text-align: center; margin: 20px 0; color: var(--text-muted);">
                    üì∑
                </div>`;
            }

            document.getElementById('modal-body').innerHTML = `
                ${previewHTML}
                <table style="width: 100%; margin-top: 20px;">
                    <tr><td><strong>Nom:</strong></td><td>${icon.nom_icon}</td></tr>
                    <tr><td><strong>Description:</strong></td><td>${icon.description_icon || 'Aucune'}</td></tr>
                    <tr><td><strong>Cat√©gorie:</strong></td><td>${icon.categorie || 'Sans cat√©gorie'}</td></tr>
                    <tr><td><strong>Type:</strong></td><td>${getTypeDisplayName(icon.type_source)}</td></tr>
                    <tr><td><strong>Dimensions:</strong></td><td>${icon.largeur_defaut || 32}√ó${icon.hauteur_defaut || 32}px</td></tr>
                    ${icon.taille_fichier ? `<tr><td><strong>Taille:</strong></td><td>${formatFileSize(icon.taille_fichier)}</td></tr>` : ''}
                </table>
            `;

            document.getElementById('preview-modal').style.display = 'flex';
        }


        // Filtrage
        function filterIcons() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            filteredIcons = allIcons.filter(icon => {
                const matchesSearch = !searchTerm || 
                    icon.nom_icon.toLowerCase().includes(searchTerm) ||
                    (icon.description_icon && icon.description_icon.toLowerCase().includes(searchTerm));

                const matchesCategory = categoryFilter === 'all' || 
                    (icon.categorie || 'Sans cat√©gorie') === categoryFilter;

                const matchesType = typeFilter === 'all' || 
                    icon.type_source === typeFilter;

                return matchesSearch && matchesCategory && matchesType;
            });

            renderIcons();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = 'all';
            document.getElementById('type-filter').value = 'all';
            filterIcons();
        }

        // Statistiques
        function updateStatistics() {
            const stats = {
                total: allIcons.length,
                industrial: allIcons.filter(i => i.type_source === 'industrial').length,
                custom: allIcons.filter(i => i.type_source === 'upload').length,
                external: allIcons.filter(i => i.type_source === 'external').length
            };

            document.getElementById('total-icons').textContent = stats.total;
            document.getElementById('industrial-icons').textContent = stats.industrial;
            document.getElementById('custom-icons').textContent = stats.custom;
            document.getElementById('external-icons').textContent = stats.external;
        }

        // Population des cat√©gories
        function populateCategories() {
            const categories = new Set();
            allIcons.forEach(icon => {
                categories.add(icon.categorie || 'Sans cat√©gorie');
            });

            const filter = document.getElementById('category-filter');
            const currentValue = filter.value;
            
            filter.innerHTML = '<option value="all">Toutes</option>';
            
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = getCategoryDisplayName(category);
                filter.appendChild(option);
            });

            filter.value = currentValue;
        }

        // Upload de fichiers
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                return file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024;
            });

            if (validFiles.length === 0) {
                showNotification('Aucun fichier image valide s√©lectionn√©', 'error');
                return;
            }

            showNotification(`Upload de ${validFiles.length} fichier(s) en cours...`, 'info');

            for (const file of validFiles) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('category', 'custom');
                    formData.append('description', `Image upload√©e: ${file.name}`);

                    const response = await fetch('/api/icons/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!result.success) {
                        console.error('Erreur upload:', result.error);
                        showNotification(`Erreur upload ${file.name}: ${result.error}`, 'error');
                    }
                } catch (error) {
                    showNotification(`Erreur upload ${file.name}: ${error.message}`, 'error');
                }
            }

            showNotification(`${validFiles.length} fichier(s) upload√©(s) avec succ√®s`, 'success');
            await loadIcons();
        }

        // Actions sur les ic√¥nes
        async function deleteIcon(iconId) {
            if (!confirm('Supprimer cette ic√¥ne d√©finitivement ?')) return;

            try {
                const response = await fetch(`/api/icons/${iconId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Ic√¥ne supprim√©e avec succ√®s', 'success');
                    await loadIcons();
                } else {
                    showNotification('Erreur suppression: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('Erreur suppression: ' + error.message, 'error');
            }
        }

        function editIcon(iconId) {
            // √Ä impl√©menter selon vos besoins
            console.log('√âdition ic√¥ne:', iconId);
        }

        // Utilitaires
        function getCategoryDisplayName(category) {
            const displayNames = {
                'actionneurs': '‚ö° Actionneurs',
                'capteurs': 'üìä Capteurs',
                'vannes': 'üîµ Vannes',
                'tuyauterie': 'üîó Tuyauterie',
                'indicateurs': 'üîü Indicateurs',
                'controle': 'üéÆ Contr√¥le',
                'custom': 'üé® Personnalis√©',
                'industrial': 'üè≠ Industriel',
                'interface': 'üíª Interface',
                'navigation': 'üß≠ Navigation'
            };
            return displayNames[category] || category;
        }

        function getTypeDisplayName(type) {
            const types = {
                'industrial': 'Industrielle',
                'external': 'Externe',
                'upload': 'Personnalis√©e'
            };
            return types[type] || type;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Export des ic√¥nes s√©lectionn√©es vers l'√©diteur
        window.getSelectedIcons = function() {
            return Array.from(selectedIcons).map(id => 
                allIcons.find(icon => (icon.id_icon || icon.id) === id)
            ).filter(icon => icon);
        };

        console.log('üé® Interface de gestion des ic√¥nes pr√™te');
    </script>
</body>
</html>