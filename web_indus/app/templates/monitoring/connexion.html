<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion Automate - IHM Arthur</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/monitoring/connexion.css') }}">
</head>
<body>
    <div class="container">
        <!-- En-tête -->
        <div class="header">
            <h1>🔗 Connexion Automate S7</h1>
            <p>Interface de connexion pour automates Siemens S7</p>
            
            <!-- Navigation -->
            <div class="navigation">
            <a href="{{ url_for('main.index') }}" class="nav-btn">🖧 Connexion</a>
            <a href="{{ url_for('main.tags') }}" class="nav-btn">🏷️ Gestion Tags</a>
            <a href="{{ url_for('main.supervision') }}" class="nav-btn">🔖 Tags Espion</a>
            <a href="{{ url_for('main.graphics_designer') }}" class="nav-btn">🎨 Éditeur IHM</a>
            <a href="{{ url_for('main.user_management') }}" class="nav-btn">👥 Utilisateurs</a>
            <a href="{{ url_for('main.projects_management') }}" class="nav-btn">📁 Projet</a>
            <a href="{{ url_for('main.dashboard') }}" class="nav-btn">📊 Dashbord</a>
            <form action="{{ url_for('main.disconnect_automate') }}" method="POST" style="display:inline;">
                <button type="submit" class="nav-btn">🔌 Déconnexion</button>
            </form>
        </div>

        <!-- Messages flash -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Section Connexion -->
        <div class="card">
            <h2>🔗 Connexion Automate Siemens S7</h2>
            
            <!-- Statut actuel -->
            <div class="status-display {% if status.connected %}status-connected{% else %}status-disconnected{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <div>
                        <strong>Statut:</strong> 
                        {% if status.connected %}
                            <span style="color: #28a745;">✅ Connecté</span>
                            {% if status.simulation_mode %}(Mode Simulation){% endif %}
                        {% else %}
                            <span style="color: #dc3545;">❌ Déconnecté</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if status.connected and status.ip_address %}
                        <strong>IP:</strong> {{ status.ip_address }}
                        {% if not status.simulation_mode %}
                            (Rack {{ status.rack }}, Slot {{ status.slot }})
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Formulaire de connexion -->
            <form method="POST" action="{{ url_for('main.connect_automate') }}" class="form-grid">
                <div class="form-group">
                    <label for="ip_address">💻 Adresse IP Automate:</label>
                    <div>
                        <input type="text" id="ip_address" name="ip_address" 
                               value="{{ status.ip_address or '' }}" 
                               placeholder="Saisissez l'IP de votre automate"
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                               title="Format: 192.168.0.1"
                               required>
                        
                        <div class="ip-status" id="ip-status" style="display: none;"></div>
                        
                        <!-- Suggestions d'IP courantes -->
                        <div class="ip-suggestions">
                            <span style="font-size: 0.8em; color: #666;">💡 IPs courantes:</span>
                            <button type="button" class="ip-suggestion-btn" onclick="useIP('192.168.0.1')">192.168.0.1</button>
                            <button type="button" class="ip-suggestion-btn" onclick="useIP('192.168.1.1')">192.168.1.1</button>
                            <button type="button" class="ip-suggestion-btn" onclick="useIP('10.0.0.1')">10.0.0.1</button>
                        </div>
                        
                        <!-- Outils réseau -->
                        <div class="network-tools">
                            <button type="button" onclick="testPing()" class="btn btn-secondary btn-small">
                                📡 TEST PING
                            </button>
                            <button type="button" onclick="scanAutomates()" class="btn btn-secondary btn-small">
                                🔍 SCANNER AUTOMATES
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rack">🔧 Rack:</label>
                    <input type="number" id="rack" name="rack" 
                           value="{{ status.rack or 0 }}" min="0" max="7" required>
                </div>
                
                <div class="form-group">
                    <label for="slot">📍 Slot:</label>
                    <input type="number" id="slot" name="slot" 
                           value="{{ status.slot or 1 }}" min="0" max="31" required>
                </div>
                
                <div class="form-group">
                    <label>🚀 Actions:</label>
                    <div class="btn-group">
                        {% if status.connected %}
                            <button type="submit" formaction="{{ url_for('main.disconnect_automate') }}" 
                                    class="btn btn-danger">
                                🔌 DÉCONNECTER
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-primary">
                                🔗 CONNEXION RÉELLE
                            </button>
                            <button type="submit" name="force_simulation" value="on" 
                                    class="btn" style="background: #FF9800; color: white;">
                                🔄 MODE SIMULATION
                            </button>
                        {% endif %}
                    </div>
                </div>
            </form>

            <!-- Informations de diagnostic -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3>🔍 Diagnostic de Connexion</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>Driver S7:</strong> 
                        {% if status.driver_available %}
                            <span style="color: #28a745;">✅ Disponible</span>
                        {% else %}
                            <span style="color: #ffc107;">⚠️ Non disponible</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Validation Ping:</strong> 
                        {% if status.validation_ping %}
                            <span style="color: #28a745;">✅ Activée</span>
                        {% else %}
                            <span style="color: #6c757d;">➖ Désactivée</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Tags en cache:</strong> 
                        <span style="color: #2a5298;">{{ status.tags_en_cache or 0 }}</span>
                    </div>
                    <div>
                        <strong>Dernière mise à jour:</strong> 
                        <span style="color: #6c757d;">{{ status.timestamp.split('T')[1][:8] if status.timestamp else '--:--:--' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fonctions utilitaires
        function useIP(ip) {
            document.getElementById('ip_address').value = ip;
            validateIP();
            testPing();
        }

        function validateIP() {
            const input = document.getElementById('ip_address');
            const status = document.getElementById('ip-status');
            const ip = input.value;
            
            const isValid = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(ip);
            
            if (ip === '') {
                status.style.display = 'none';
                input.style.borderColor = '#ddd';
                return false;
            }
            
            if (isValid && ip.split('.').every(part => parseInt(part) <= 255)) {
                status.textContent = '✅ Format IP valide';
                status.className = 'ip-status ip-valid';
                status.style.display = 'block';
                input.style.borderColor = '#4CAF50';
                return true;
            } else {
                status.textContent = '❌ Format IP invalide';
                status.className = 'ip-status ip-invalid';
                status.style.display = 'block';
                input.style.borderColor = '#f44336';
                return false;
            }
        }

        async function testPing() {
            const ip = document.getElementById('ip_address').value;
            if (!validateIP()) {
                alert('Veuillez saisir une IP valide');
                return;
            }
            
            const status = document.getElementById('ip-status');
            status.textContent = '📡 Test ping en cours...';
            status.className = 'ip-status';
            
            try {
                const response = await fetch(`/api/test_ping?ip=${ip}`);
                const result = await response.json();
                
                if (result.success) {
                    status.textContent = '✅ Ping réussi - Automate accessible';
                    status.className = 'ip-status ip-valid';
                } else {
                    status.textContent = '❌ Ping échoué - Vérifiez IP/réseau';
                    status.className = 'ip-status ip-invalid';
                }
            } catch (error) {
                status.textContent = '⚠️ Erreur test ping';
                status.className = 'ip-status ip-invalid';
            }
        }

        async function scanAutomates() {
            const ip = document.getElementById('ip_address').value;
            let baseIp = '192.168.0';
            
            if (ip && validateIP()) {
                const parts = ip.split('.');
                if (parts.length >= 3) {
                    baseIp = `${parts[0]}.${parts[1]}.${parts[2]}`;
                }
            }
            
            const status = document.getElementById('ip-status');
            status.textContent = `🔍 Scan réseau ${baseIp}.1-20 en cours...`;
            status.className = 'ip-status';
            status.style.display = 'block';
            
            try {
                const response = await fetch(`/api/scan_network?base_ip=${baseIp}&start=1&end=20`);
                const result = await response.json();
                
                if (result.automates_found && result.automates_found.length > 0) {
                    const automates = result.automates_found
                        .filter(a => a.s7_port)
                        .map(a => a.ip);
                    
                    if (automates.length > 0) {
                        status.textContent = `🎯 ${automates.length} automate(s) trouvé(s)`;
                        status.className = 'ip-status ip-valid';
                        
                        const choice = confirm(`Automates S7 trouvés :\n${automates.join('\n')}\n\nUtiliser ${automates[0]} ?`);
                        if (choice) {
                            document.getElementById('ip_address').value = automates[0];
                            validateIP();
                        }
                    } else {
                        status.textContent = '❌ Aucun automate S7 trouvé';
                        status.className = 'ip-status ip-invalid';
                    }
                } else {
                    status.textContent = '❌ Aucun équipement trouvé sur ce réseau';
                    status.className = 'ip-status ip-invalid';
                }
            } catch (error) {
                status.textContent = '❌ Erreur scan: ' + error.message;
                status.className = 'ip-status ip-invalid';
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page Connexion Automate - Prête');
            
            // Validation en temps réel
            document.getElementById('ip_address').addEventListener('input', validateIP);
            
            // Validation initiale si IP pré-remplie
            if (document.getElementById('ip_address').value) {
                validateIP();
            }
        });
    </script>
</body>
</html>