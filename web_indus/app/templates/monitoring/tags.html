<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Tags - IHM Arthur</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/monitoring/tags.css') }}">
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1>üè∑Ô∏è Gestion des Tags</h1>
            <p>Configuration et gestion des tags Siemens S7</p>
            
            <!-- Navigation -->
            <div class="navigation">
            <a href="{{ url_for('main.index') }}" class="nav-btn">üñß Connexion</a>
            <a href="{{ url_for('main.tags') }}" class="nav-btn">üè∑Ô∏è Gestion Tags</a>
            <a href="{{ url_for('main.supervision') }}" class="nav-btn">üîñ Tags Espion</a>
            <a href="{{ url_for('main.graphics_designer') }}" class="nav-btn">üé® √âditeur IHM</a>
            <a href="{{ url_for('main.user_management') }}" class="nav-btn">üë• Utilisateurs</a>
            <a href="{{ url_for('main.projects_management') }}" class="nav-btn">üìÅ Projet</a>
            <a href="{{ url_for('main.dashboard') }}" class="nav-btn">üìä Dashbord</a>
            <form action="{{ url_for('main.disconnect_automate') }}" method="POST" style="display:inline;">
                <button type="submit" class="nav-btn">üîå D√©connexion</button>
            </form>
        </div>

        <!-- Section Gestion Tags -->
        <div class="card">
            <h2>üè∑Ô∏è Gestion des Tags Siemens S7</h2>
            
            <!-- Statistiques CORRIG√âES -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number">{{ tags|length if tags else 0 }}</div>
                    <div class="stat-label">Tags Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if tags %}
                            {{ tags|selectattr('disponibilite_externe', 'equalto', True)|list|length }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stat-label">Actifs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if tags %}
                            {% set count = [] %}
                            {% for tag in tags %}
                                {% if tag.acces and 'W' in tag.acces %}
                                    {% if count.append(1) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {{ count|length }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stat-label">√âcriture</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if tags %}
                            {{ tags|selectattr('type_donnee', 'equalto', 'BOOL')|list|length }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stat-label">BOOL</div>
                </div>
            </div>

            <!-- Formulaire de cr√©ation de tag -->
            <form id="tag-form" class="tag-form">
                <div class="form-group">
                    <label for="tag_nom">üè∑Ô∏è Nom du Tag:</label>
                    <input type="text" id="tag_nom" placeholder="ex: bp_marche" required>
                    <div class="helper-text">Nom unique pour identifier le tag</div>
                </div>

                <div class="form-group">
                    <label for="tag_db">üóÇÔ∏è Num√©ro DB:</label>
                    <input type="number" id="tag_db" placeholder="1" min="1" max="9999" required>
                    <div class="helper-text">Num√©ro du Data Block (DB1, DB2...)</div>
                </div>

                <div class="form-group">
                    <label for="tag_type">üìã Type de Donn√©e:</label>
                    <select id="tag_type" onchange="updateOffsetHelper()" required>
                        <option value="BOOL">BOOL (Bit)</option>
                        <option value="INT">INT (16-bit)</option>
                        <option value="DINT">DINT (32-bit)</option>
                        <option value="REAL">REAL (32-bit Float)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tag_offset">üìç Offset (Adresse):</label>
                    <input type="text" id="tag_offset" placeholder="0.0" required>
                    <div class="helper-text" id="offset-helper">
                        Pour BOOL: byte.bit (ex: 0.0, 1.3)<br>
                        Pour INT/DINT/REAL: byte (ex: 2, 4, 6)
                    </div>
                </div>

                <div class="form-group">
                    <label for="tag_acces">üîê Acc√®s:</label>
                    <select id="tag_acces">
                        <option value="R">Lecture seule</option>
                        <option value="W">√âcriture seule</option>
                        <option value="RW">Lecture/√âcriture</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tag_description">üìù Description:</label>
                    <input type="text" id="tag_description" placeholder="Description du tag">
                    <div class="helper-text">Description optionnelle du tag</div>
                </div>

                <div class="form-group">
                    <label>‚ö° Actions:</label>
                    <div class="btn-group">
                        <button type="button" onclick="previewAdresse()" class="btn btn-info btn-small">
                            üëÅÔ∏è APER√áU ADRESSE
                        </button>
                        <button type="button" onclick="ajouterTag()" class="btn btn-success">
                            ‚ûï AJOUTER TAG
                        </button>
                        <button type="button" onclick="chargerTagsDefaut()" class="btn btn-secondary btn-small">
                            üîÑ TAGS D√âFAUT
                        </button>
                    </div>
                </div>
            </form>

            <!-- Barre de recherche et filtres -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-tags" placeholder="üîç Rechercher un tag..." onkeyup="filtrerTags()">
                <select id="filter-type" onchange="filtrerTags()">
                    <option value="">Tous types</option>
                    <option value="BOOL">BOOL</option>
                    <option value="INT">INT</option>
                    <option value="DINT">DINT</option>
                    <option value="REAL">REAL</option>
                </select>
                <select id="filter-access" onchange="filtrerTags()">
                    <option value="">Tous acc√®s</option>
                    <option value="R">Lecture</option>
                    <option value="W">√âcriture</option>
                    <option value="RW">Lecture/√âcriture</option>
                </select>
                <button type="button" onclick="clearFilters()" class="btn btn-secondary btn-small">
                    üóëÔ∏è EFFACER FILTRES
                </button>
            </div>

            <!-- Liste des tags configur√©s -->
            <div style="margin-top: 30px;">
                <h3>üìã Tags Configur√©s (<span id="tags-count">{{ tags|length if tags else 0 }}</span>)</h3>
                
                <table class="data-table" id="tags-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Adresse S7</th>
                            <th>Type</th>
                            <th>Acc√®s</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tags-list">
                        {% if tags %}
                            {% for tag in tags %}
                            <tr>
                                <td><strong>{{ tag.nom_tag }}</strong></td>
                                <td><code>{{ tag.adresse_tag }}</code></td>
                                <td><span class="tag-value">{{ tag.type_donnee }}</span></td>
                                <td>{{ tag.acces }}</td>
                                <td>{{ tag.description_tag or '-' }}</td>
                                <td class="tag-actions">
                                    <button onclick="lireTag('{{ tag.nom_tag }}')" class="btn btn-primary btn-small" title="Lire">üìñ</button>
                                    {% if tag.acces and 'W' in tag.acces %}
                                    <button onclick="ecrireTag('{{ tag.nom_tag }}')" class="btn btn-success btn-small" title="√âcrire">‚úèÔ∏è</button>
                                    {% endif %}
                                    <!--<button onclick="supprimerTag({{ tag.id_tag }})" class="btn btn-danger btn-small" title="Supprimer">üóëÔ∏è</button> -->
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                    Aucun tag configur√©. Cr√©ez vos premiers tags ci-dessus.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Actions en lot -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>‚öôÔ∏è Actions en Lot</h4>
                <div class="btn-group" style="margin-top: 10px;">
                    <button type="button" onclick="exportTags()" class="btn btn-info btn-small">
                        üíæ EXPORTER TAGS
                    </button>
                    <button type="button" onclick="importTags()" class="btn btn-info btn-small">
                        üìÇ IMPORTER TAGS
                    </button>
                    <button type="button" onclick="validateAllTags()" class="btn btn-secondary btn-small">
                        ‚úÖ VALIDER TOUS
                    </button>
                    <button type="button" onclick="deleteAllTags()" class="btn btn-danger btn-small">
                        üóëÔ∏è SUPPRIMER TOUS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let allTags = [];
        let filteredTags = [];

        // Fonctions utilitaires pour l'offset
        function updateOffsetHelper() {
            const type = document.getElementById('tag_type').value;
            const helper = document.getElementById('offset-helper');
            
            switch (type) {
                case 'BOOL':
                    helper.innerHTML = 'üìç Pour BOOL: byte.bit (ex: 0.0, 1.3, 2.7)<br>Le bit doit √™tre entre 0 et 7';
                    document.getElementById('tag_offset').placeholder = '0.0';
                    break;
                case 'INT':
                    helper.innerHTML = 'üìç Pour INT: byte pair (ex: 0, 2, 4, 6...)<br>Taille: 2 bytes (16-bit)';
                    document.getElementById('tag_offset').placeholder = '2';
                    break;
                case 'DINT':
                    helper.innerHTML = 'üìç Pour DINT: byte multiple de 4 (ex: 0, 4, 8, 12...)<br>Taille: 4 bytes (32-bit)';
                    document.getElementById('tag_offset').placeholder = '4';
                    break;
                case 'REAL':
                    helper.innerHTML = 'üìç Pour REAL: byte multiple de 4 (ex: 0, 4, 8, 12...)<br>Taille: 4 bytes (32-bit float)';
                    document.getElementById('tag_offset').placeholder = '8';
                    break;
            }
        }

        // Pr√©visualisation de l'adresse
        async function previewAdresse() {
            const db = document.getElementById('tag_db').value;
            const type = document.getElementById('tag_type').value;
            const offset = document.getElementById('tag_offset').value;

            if (!db || !offset) {
                alert('Veuillez remplir DB et Offset');
                return;
            }

            // G√©n√©ration locale de l'adresse
            let adresse;
            switch (type) {
                case 'BOOL':
                    if (!offset.includes('.')) {
                        alert('Pour BOOL, utilisez le format byte.bit (ex: 0.0)');
                        return;
                    }
                    adresse = `DB${db}.DBX${offset}`;
                    break;
                case 'INT':
                    adresse = `DB${db}.DBW${offset}`;
                    break;
                case 'DINT':
                    adresse = `DB${db}.DBD${offset}`;
                    break;
                case 'REAL':
                    adresse = `DB${db}.DBD${offset}`;
                    break;
            }
            alert(`üìç Adresse g√©n√©r√©e: ${adresse}`);
        }

        // Ajouter un tag
        async function ajouterTag() {
            const nom = document.getElementById('tag_nom').value;
            const db = document.getElementById('tag_db').value;
            const type = document.getElementById('tag_type').value;
            const offset = document.getElementById('tag_offset').value;
            const acces = document.getElementById('tag_acces').value;
            const description = document.getElementById('tag_description').value;

            if (!nom || !db || !offset) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            try {
                const response = await fetch('/api/create_tag_flexible', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nom_tag: nom,
                        db: parseInt(db),
                        type_donnee: type,
                        offset: offset,
                        acces: acces,
                        description_tag: description
                    })
                });

                const data = await response.json();

                if (response.ok && data.tag) {
                    alert(`‚úÖ Tag "${nom}" cr√©√© avec succ√®s (${data.adresse_generee})`);
                    
                    // R√©initialiser le formulaire
                    document.getElementById('tag-form').reset();
                    document.getElementById('tag_db').value = '';
                    document.getElementById('tag_type').value = 'BOOL';
                    updateOffsetHelper();

                    // Recharger la page pour voir le nouveau tag
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(`‚ùå ${data.error || 'Erreur cr√©ation tag'}`);
                }

            } catch (error) {
                alert(`‚ùå Erreur cr√©ation tag: ${error.message}`);
            }
        }

        // Supprimer un tag
        async function supprimerTag(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce tag ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tags/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Tag supprim√© avec succ√®s');
                    setTimeout(() => location.reload(), 500);
                } else {
                    const data = await response.json();
                    alert(`‚ùå ${data.error || 'Erreur suppression'}`);
                }

            } catch (error) {
                alert(`‚ùå Erreur suppression: ${error.message}`);
            }
        }

        // Lire un tag
        async function lireTag(tagName) {
            try {
                const response = await fetch(`/api/read/${tagName}`);
                const data = await response.json();

                if (data.error) {
                    alert(`‚ùå ${data.error}`);
                    return;
                }

                alert(`üìñ ${tagName}: ${data.valeur} (${data.qualite})`);

            } catch (error) {
                alert(`‚ùå Erreur lecture ${tagName}: ${error.message}`);
            }
        }

        // √âcrire un tag
        async function ecrireTag(tagName) {
            const valeur = prompt(`√âcrire une valeur dans ${tagName}:`);
            if (valeur === null) return;

            try {
                const response = await fetch(`/api/write/${tagName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        valeur: valeur
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úèÔ∏è ${tagName} = ${data.valeur}`);
                } else {
                    alert(`‚ùå ${data.error || 'Erreur √©criture'}`);
                }

            } catch (error) {
                alert(`‚ùå Erreur √©criture ${tagName}: ${error.message}`);
            }
        }

        // Charger les tags par d√©faut
        async function chargerTagsDefaut() {
            if (!confirm('Charger les tags par d√©faut Siemens ? (Les tags existants seront conserv√©s)')) {
                return;
            }

            try {
                const response = await fetch('/admin/init_tags', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Tags par d√©faut charg√©s');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('‚ùå Erreur lors du chargement des tags par d√©faut');
                }
            } catch (error) {
                alert(`‚ùå Erreur: ${error.message}`);
            }
        }

        // Filtrer les tags (simulation)
        function filtrerTags() {
            // Dans un vrai projet, vous filtreriez les tags selon les crit√®res
            console.log('Filtrage des tags...');
        }

        function clearFilters() {
            document.getElementById('search-tags').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-access').value = '';
            console.log('Filtres effac√©s');
        }

        // Actions en lot
        function exportTags() {
            const config = {
                version: '1.0',
                export_date: new Date().toISOString(),
                tags: [], // Sera rempli via API
                metadata: {
                    export_par: 'IHM_Arthur_Gestion_Tags'
                }
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tags_config_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Configuration des tags export√©e');
        }

        function importTags() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        if (config.tags && Array.isArray(config.tags)) {
                            const message = `Importer ${config.tags.length} tags ?\n\nCela peut remplacer des tags existants.`;
                            
                            if (confirm(message)) {
                                alert('üìÇ Fonctionnalit√© d\'import √† impl√©menter via API');
                            }
                        } else {
                            alert('‚ùå Format de fichier invalide');
                        }
                    } catch (error) {
                        alert('‚ùå Erreur lecture fichier: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function validateAllTags() {
            alert('‚úÖ Validation de tous les tags (fonctionnalit√© √† impl√©menter)');
        }

        function deleteAllTags() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Supprimer TOUS les tags ?\n\nCette action est irr√©versible !')) {
                return;
            }
            
            alert('üóëÔ∏è Suppression en lot (fonctionnalit√© √† impl√©menter)');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page Gestion Tags - Pr√™te');
            
            // Initialiser l'helper des offsets
            updateOffsetHelper();
        });
    </script>
</body>
</html>